name: SEAP Scraper

on:
  schedule:
    # Ruleaza la fiecare ora, luni-vineri, 8:00-18:00 (ora Romaniei = UTC+2/+3)
    - cron: '0 6-16 * * 1-5'
    # Rulare garantata o data pe zi la 19:00 (ora Romaniei) - backup final
    - cron: '0 17 * * 1-5'
  workflow_dispatch:  # Permite rulare manuala din GitHub

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager
      
      - name: Download latest data from Gist
        run: |
          echo "Downloading latest seap_data.json from Gist..."
          curl -s -o seap_data.json "https://gist.githubusercontent.com/AlexxG24/916c4f36e09196cd4e83e8e3bafe947a/raw/seap_data.json?t=$(date +%s)" || echo '{"history":[],"totalAllTime":0}' > seap_data.json
          echo "Current data:"
          cat seap_data.json
      
      - name: Run scraper
        env:
          CI: true
          GH_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: python seap_scraper.py
      
      - name: Update Gist
        if: always()
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          echo "=== seap_data.json content ==="
          cat seap_data.json
          echo ""
          echo "=== Updating Gist ==="
          python -c "
          import json, urllib.request, os
          token = os.environ.get('GIST_TOKEN', '')
          if not token:
              print('[WARN] GIST_TOKEN not set, skipping Gist update')
              exit(0)
          data = open('seap_data.json','r').read()
          payload = json.dumps({'files':{'seap_data.json':{'content':data}}})
          req = urllib.request.Request(
              'https://api.github.com/gists/916c4f36e09196cd4e83e8e3bafe947a',
              data=payload.encode(), method='PATCH',
              headers={'Authorization': f'token {token}', 'Accept': 'application/vnd.github+json'}
          )
          resp = urllib.request.urlopen(req)
          print(f'Gist updated: {resp.status}')
          "
